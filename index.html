<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: #000000;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid #4facfe;
            padding-bottom: 10px;
        }

        .workout-form {
            display: grid;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }

        select, input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            background: white;
            color: #28a745;
            border: 2px solid #28a745;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .search-btn {
            background: white;
            color: #007bff;
            border: 2px solid #007bff;
        }

        .search-btn:hover {
            background: #007bff;
            color: white;
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.4);
        }

        .show-all-btn {
            background: white;
            color: #fd7e14;
            border: 2px solid #fd7e14;
        }

        .show-all-btn:hover {
            background: #fd7e14;
            color: white;
            box-shadow: 0 5px 15px rgba(253, 126, 20, 0.4);
        }

        .search-container {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .search-container .btn {
            justify-self: start;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
        }

        .search-summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .search-summary h3 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .search-summary p {
            margin: 0;
            color: #666;
            font-size: 0.9em;
        }

        .workout-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .workout-item {
            background: white;
            padding: 25px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .workout-info {
            flex-grow: 1;
        }

        .workout-date {
            color: #666;
            font-size: 0.9em;
        }

        .workout-details {
            font-weight: bold;
            color: #333;
        }

        .calories {
            font-size: 1.2em;
            color: #4facfe;
            font-weight: bold;
        }

        .delete-btn {
            background: white;
            color: #dc3545;
            border: 2px solid #dc3545;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #dc3545;
            color: white;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4facfe;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" style="display: flex; align-items: center; justify-content: space-between;">
            <div id="loginContainer" style="flex: 1; text-align: left;">
                <button id="loginBtn" class="btn" onclick="location.href='login.html'" style="padding: 8px 12px; font-size: 18px; display: flex; align-items: center; justify-content: center;">
<svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user" viewBox="0 0 24 24" style="width: 20px; height: 20px;">
    <path d="M20 21v-2a4 4 0 0 0-3-3.87"></path>
    <path d="M4 21v-2a4 4 0 0 1 3-3.87"></path>
    <circle cx="12" cy="7" r="4"></circle>
</svg>
                </button>
                <span id="usernameDisplay" style="display:none; font-weight: bold;"></span>
                <button id="logoutBtn" class="btn" style="margin-left: 10px; display:none;">Logout</button>
            </div>
            <div style="flex: 2; text-align: center;">
                <h1>üèãÔ∏è Fitness Tracker</h1>
                <p>Track your workouts and monitor your progress</p>
            </div>
            <div style="flex: 1;"></div>
        </div>

        <script>
            // Simulate login state using localStorage
            function checkLogin() {
                const username = localStorage.getItem('username');
                const loginBtn = document.getElementById('loginBtn');
                const usernameDisplay = document.getElementById('usernameDisplay');
                const logoutBtn = document.getElementById('logoutBtn');

                if (username) {
                    loginBtn.style.display = 'none';
                    usernameDisplay.style.display = 'inline';
                    usernameDisplay.textContent = `Welcome, ${username}`;
                    logoutBtn.style.display = 'inline-block';
                } else {
                    loginBtn.style.display = 'inline-block';
                    usernameDisplay.style.display = 'none';
                    logoutBtn.style.display = 'none';
                }
            }

            // Call checkLogin on page load
            window.onload = function() {
                checkLogin();

                const logoutBtn = document.getElementById('logoutBtn');
                logoutBtn.addEventListener('click', function() {
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    window.location.href = 'login.html';
                });
            };
        </script>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalWorkouts">0</div>
                <div class="stat-label">Total Workouts</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalCalories">0</div>
                <div class="stat-label">Total Calories Burned</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgCalories">0</div>
                <div class="stat-label">Avg Calories/Session</div>
            </div>
        </div>

        <div class="dashboard">
            <div class="section">
                <h2> Add New Workout</h2>
        <form class="workout-form" id="workoutForm">
            <div class="form-group">
                <label for="workoutType">Workout Type:</label>
                <select id="workoutType" required>
                    <option value="">Select Workout</option>
                    <option value="running">üèÉ Running</option>
                    <option value="cycling">üö¥ Cycling</option>
                    <option value="swimming">üèä Swimming</option>
                    <option value="weightlifting">üèãÔ∏è Weightlifting</option>
                    <option value="yoga">üßò Yoga</option>
                    <option value="jump-rope">ü™¢ Jump Rope</option>
                    <option value="basketball">üèÄ Basketball</option>
                    <option value="tennis">üéæ Tennis</option>
                    <option value="boxing">ü•ä Boxing</option>
                    <option value="dancing">üíÉ Dancing</option>
                </select>
            </div>
            <div class="form-group">
                <label for="duration">Duration (minutes):</label>
                <input type="number" id="duration" min="1" max="300" required>
            </div>
            <button type="submit" class="btn">Add Workout</button>
        </form>
            </div>

            <div class="section">
                <h2>Progress Chart</h2>
                <div class="chart-container">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>

            <div class="section">
                <h2> Recent Workouts</h2>
                <div class="workout-list" id="workoutList">
                    <p style="text-align: center; color: #666; margin-top: 20px;">No workouts added yet. Start tracking!</p>
                </div>
            </div>

            <div class="section">
                <h2> Search Past Workouts</h2>
                <div class="search-container">
                    <div class="form-group">
                        <label for="searchDate">Select Date to View Workouts:</label>
                        <input type="date" id="searchDate">
                    </div>
                    <button type="button" class="btn search-btn" id="searchBtn">Search Workouts</button>
                    <button type="button" class="btn show-all-btn" id="showAllBtn">Show All Workouts</button>
                </div>
                <div id="searchResults" class="search-results">
                    <p style="text-align: center; color: #666; margin-top: 20px;">Select a date and click "Search Workouts" to view past data.</p>
                </div>
            </div>
        </div>
    </div>

<script>
    const workoutRates = {
        running: 8.3, cycling: 7.0, swimming: 6.0, weightlifting: 3.0,
        yoga: 2.5, 'jump-rope': 10.0, basketball: 6.0, tennis: 5.0,
        boxing: 7.0, dancing: 4.5
    };

    const workoutForm = document.getElementById('workoutForm');
    const workoutList = document.getElementById('workoutList');
    const totalWorkoutsEl = document.getElementById('totalWorkouts');
    const totalCaloriesEl = document.getElementById('totalCalories');
    const avgCaloriesEl = document.getElementById('avgCalories');
    const progressChartCanvas = document.getElementById('progressChart');
    const searchBtn = document.getElementById('searchBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const searchResults = document.getElementById('searchResults');

    let workouts = [];
    const token = localStorage.getItem("token");
    const username = localStorage.getItem("username");

    // ‚úÖ Redirect if not logged in
    if (!token) {
        alert("You must log in first.");
        window.location.href = "login.html";
    }

    // Chart setup
    let progressChart = new Chart(progressChartCanvas, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Calories Burned',
                data: [],
                borderColor: '#4facfe',
                backgroundColor: 'rgba(79, 172, 254, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { beginAtZero: true, title: { display: true, text: 'Calories' } },
                x: { title: { display: true, text: 'Date' } }
            }
        }
    });

    // ================== API CALLS ==================

    async function loadAllWorkouts() {
        try {
            const res = await fetch("http://localhost:3000/api/workouts", {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            if (Array.isArray(data.workouts)) {
                workouts = data.workouts.sort((a, b) => new Date(b.date) - new Date(a.date));
                updateUI();
            }
        } catch (err) {
            console.error("Error loading workouts:", err);
        }
    }

    async function loadRecentWorkouts() {
        try {
            const res = await fetch("http://localhost:3000/api/workouts/recent?limit=10", {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            if (Array.isArray(data.workouts)) {
                renderRecentWorkouts(data.workouts);
            }
        } catch (err) {
            console.error("Error loading recent workouts:", err);
        }
    }

    async function addWorkout(type, duration, calories) {
        try {
            const res = await fetch("http://localhost:3000/api/workouts", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer " + token
                },
                body: JSON.stringify({ type, duration, calories })
            });
            const data = await res.json();
            if (data.workout) {
                // Reload everything after adding a workout
                await loadAllWorkouts();
                workoutForm.reset();
                alert(`Workout added! You burned ${calories} calories.`);
            } else {
                alert("Failed to add workout: " + (data.message || "Unknown error"));
            }
        } catch (err) {
            console.error("Error adding workout:", err);
        }
    }

    async function deleteWorkout(id) {
        if (!confirm('Are you sure you want to delete this workout?')) return;
        try {
            const res = await fetch(`http://localhost:3000/api/workouts/${id}`, {
                method: "DELETE",
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            if (data.message === "Workout deleted successfully") {
                await loadAllWorkouts();
            } else {
                alert("Failed to delete workout: " + (data.message || "Unknown error"));
            }
        } catch (err) {
            console.error("Error deleting workout:", err);
        }
    }

    async function searchWorkoutsByDate(searchDate) {
        if (!searchDate) { alert('Please select a date.'); return; }
        try {
            const res = await fetch(`http://localhost:3000/api/workouts/by-date?date=${searchDate}`, {
                headers: { "Authorization": "Bearer " + token }
            });
            const data = await res.json();
            if (Array.isArray(data.workouts)) {
                displaySearchResults(data.workouts, searchDate);
            } else {
                alert("No workouts found for the selected date.");
            }
        } catch (err) {
            console.error("Error searching workouts:", err);
        }
    }

    // ================== UI FUNCTIONS ==================

    function calculateCalories(type, duration) {
        return Math.round(workoutRates[type] * duration);
    }

    function updateStats() {
        const totalWorkouts = workouts.length;
        const totalCalories = workouts.reduce((sum, w) => sum + w.calories, 0);
        const avgCalories = totalWorkouts > 0 ? Math.round(totalCalories / totalWorkouts) : 0;
        totalWorkoutsEl.textContent = totalWorkouts;
        totalCaloriesEl.textContent = totalCalories;
        avgCaloriesEl.textContent = avgCalories;
    }

    function updateChart() {
        const last7Days = [];
        for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            last7Days.push(d.toLocaleDateString());
        }
        const dailyCalories = last7Days.map(date =>
            workouts.filter(w => new Date(w.date).toLocaleDateString() === date)
                    .reduce((sum, w) => sum + w.calories, 0)
        );
        progressChart.data.labels = last7Days;
        progressChart.data.datasets[0].data = dailyCalories;
        progressChart.update();
    }

    function renderRecentWorkouts(recentWorkouts) {
        if (recentWorkouts.length === 0) {
            workoutList.innerHTML = '<p style="text-align:center;color:#666;margin-top:20px;">No workouts added yet.</p>';
            return;
        }
        workoutList.innerHTML = recentWorkouts.map(w => `
            <div class="workout-item">
                <div class="workout-info">
                    <div class="workout-date">${new Date(w.date).toLocaleString()}</div>
                    <div class="workout-details">${w.type} - ${w.duration} min</div>
                </div>
                <div class="calories">${w.calories} cal</div>
                <button class="delete-btn" onclick="deleteWorkout('${w.id || w._id}')">Delete</button>
            </div>
        `).join('');
    }

    function updateUI() {
        updateStats();
        updateChart();
        renderRecentWorkouts(workouts.slice(0, 10)); // Show first 10 from sorted list
    }

    function displaySearchResults(filtered, searchDate) {
        const formattedDate = new Date(searchDate + 'T12:00:00').toLocaleDateString();
        if (filtered.length === 0) {
            searchResults.innerHTML = `<div class="search-summary"><h3>No workouts found for ${formattedDate}</h3></div>`;
            return;
        }
        const totalCalories = filtered.reduce((s, w) => s + w.calories, 0);
        searchResults.innerHTML = `
            <div class="search-summary"><h3>${filtered.length} workout(s) on ${formattedDate}</h3><p>Total calories: ${totalCalories}</p></div>
            ${filtered.map(w => `
                <div class="workout-item">
                    <div class="workout-info">
                        <div class="workout-date">${new Date(w.date).toLocaleString()}</div>
                        <div class="workout-details">${w.type} - ${w.duration} min</div>
                    </div>
                    <div class="calories">${w.calories} cal</div>
                </div>`).join('')}
        `;
    }

    function showAllWorkouts() {
        if (workouts.length === 0) {
            searchResults.innerHTML = '<p style="text-align:center;color:#666;margin-top:20px;">No workouts found.</p>';
            return;
        }
        const totalCalories = workouts.reduce((s, w) => s + w.calories, 0);
        searchResults.innerHTML = `
            <div class="search-summary"><h3>All ${workouts.length} workouts</h3><p>Total calories: ${totalCalories}</p></div>
            ${workouts.map(w => `
                <div class="workout-item">
                    <div class="workout-info">
                        <div class="workout-date">${new Date(w.date).toLocaleString()}</div>
                        <div class="workout-details">${w.type} - ${w.duration} min</div>
                    </div>
                    <div class="calories">${w.calories} cal</div>
                </div>`).join('')}
        `;
    }

    // ================== EVENTS ==================
    workoutForm.addEventListener('submit', e => {
        e.preventDefault();
        const type = document.getElementById('workoutType').value;
        const duration = parseInt(document.getElementById('duration').value);
        if (!type || !duration) { alert('Fill in all fields.'); return; }
        const calories = calculateCalories(type, duration);
        addWorkout(type, duration, calories);
    });

    searchBtn.addEventListener('click', () => {
        const date = document.getElementById('searchDate').value;
        searchWorkoutsByDate(date);
    });

    showAllBtn.addEventListener('click', showAllWorkouts);

    // ================== INIT ==================
    // Load all workouts on page load
    loadAllWorkouts();
</script>




</body>
</html>
